<template>
  <div class="bg-white shadow-sm py-2 border-b border-gray-200">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div
        class="flex space-x-6 md:space-x-10 text-gray-600 font-semibold text-sm md:text-base"
      >
        <a href="#" class="py-2 px-1 border-b-2 border-blue-600 text-blue-600"
          >Trang ch·ªß</a
        >
        <a
          href="/student/contract"
          class="py-2 px-1 border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500 transition-colors"
          >Th√¥ng tin h·ª£p ƒë·ªìng</a
        >
        <!-- <a
          href="#"
          class="py-2 px-1 border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500 transition-colors"
          >ƒêƒÉng k√Ω ph√≤ng</a
        > -->
        <a
          href="/student/payments"
          class="py-2 px-1 border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500 transition-colors"
          >H√≥a ƒë∆°n</a
        >
        <!-- <a
          href="#"
          class="py-2 px-1 border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500 transition-colors"
          >H·ªó tr·ª£</a
        > -->
      </div>
    </div>
  </div>

  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
    <div class="max-w-7xl mx-auto">
      <section
        class="relative rounded-xl shadow-lg p-6 md:p-10 mb-12 overflow-hidden"
        style="background-image: linear-gradient(to right, #2563eb, #3b82f6)"
      >
        <div class="absolute inset-0 bg-black opacity-30 rounded-xl"></div>
        <div
          class="relative z-10 flex flex-col md:flex-row items-center justify-between"
        >
          <div class="text-white text-center md:text-left mb-6 md:mb-0">
            <ClientOnly>
              <h1
                class="text-3xl md:text-4xl font-extrabold mb-2 leading-tight"
              >
                Ch√†o m·ª´ng {{ user.name }}
              </h1>
            </ClientOnly>

            <p class="text-lg md:text-xl font-medium">
              Ch√∫c b·∫°n m·ªôt ng√†y h·ªçc t·∫≠p v√† sinh ho·∫°t hi·ªáu qu·∫£.
            </p>
          </div>
          <div class="w-full md:w-auto">
            <div class="relative w-full md:w-72">
              <input
                type="text"
                placeholder="T√¨m ki·∫øm th√¥ng tin..."
                class="w-full pl-10 pr-4 py-2 rounded-full bg-white/90 text-gray-700 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <svg
                class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                ></path>
              </svg>
            </div>
          </div>
        </div>
      </section>

      <h2 class="text-2xl md:text-3xl font-extrabold text-gray-800 mb-8">
        DASHBOARD
      </h2>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
        <!-- Ph√≤ng c·ªßa t√¥i -->
        <div
          class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-start transition-transform hover:scale-105 hover:shadow-xl duration-300 border-t-4 border-blue-500"
        >
          <div class="flex items-center gap-3 mb-4">
            <svg
              class="w-8 h-8 text-blue-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10h14V10"
              ></path>
            </svg>
            <h3 class="text-lg font-bold text-gray-800">Ph√≤ng c·ªßa t√¥i</h3>
          </div>
          <!-- <p class="text-gray-600 text-sm">
            T√≤a nh√†: <span class="font-semibold">A</span>
          </p> -->
          <!-- <p class="text-gray-600 text-sm">
            Ph√≤ng s·ªë: <span class="font-semibold"></span>
          </p>
          <p class="text-gray-600 text-sm mb-4">
            B·∫°n c√πng ph√≤ng:
            <span class="font-semibold">L√™ VƒÉn B, Tr·∫ßn Th·ªã C</span>
          </p> -->
          <button
            @click="openRoomDetail"
            class="mt-auto px-5 py-2 text-sm font-semibold text-blue-600 border border-blue-600 rounded-full hover:bg-blue-600 hover:text-white transition-colors"
          >
            Chi ti·∫øt ph√≤ng
          </button>
        </div>
        <StudentRoomDetail
          :show="showRoomDetail"
          :room="roomDetail"
          @close="closeRoomDetail"
        />

        <!-- H√≥a ƒë∆°n -->

        <!-- <div
          class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-start transition-transform hover:scale-105 hover:shadow-xl duration-300 border-t-4 border-green-500"
        >
          <div class="flex items-center gap-3 mb-4">
            <svg
              class="w-8 h-8 text-green-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5h5l5 5h5v9a2 2 0 01-2 2z"
              ></path>
            </svg>
            <h3 class="text-lg font-bold text-gray-800">H√≥a ƒë∆°n g·∫ßn nh·∫•t</h3>
          </div>
          <p class="text-gray-600 text-sm">Ti·ªÅn ph√≤ng T10/2025</p>
          <p class="text-gray-600 text-sm">
            S·ªë ti·ªÅn:
            <span class="font-semibold text-red-600">1.200.000 VNƒê</span>
          </p>
          <p class="text-gray-600 text-sm mb-4">
            H·∫°n cu·ªëi: <span class="font-semibold">31/10/2025</span>
          </p>
          <a
            href="#"
            class="mt-auto px-5 py-2 text-sm font-semibold text-white bg-green-500 rounded-full hover:bg-green-600 transition-colors"
            >Thanh to√°n ngay</a
          >
        </div> -->

        <!-- H√≥a ƒë∆°n g·∫ßn nh·∫•t -->
        <div
          class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-start transition-transform hover:scale-105 hover:shadow-xl duration-300 border-t-4 border-green-500"
        >
          <div class="flex items-center gap-3 mb-4">
            <svg
              class="w-8 h-8 text-green-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5h5l5 5h5v9a2 2 0 01-2 2z"
              ></path>
            </svg>
            <h3 class="text-lg font-bold text-gray-800">H√≥a ƒë∆°n g·∫ßn nh·∫•t</h3>
          </div>

          <template v-if="latestPayment">
            <p class="text-gray-600 text-sm">
              Ti·ªÅn ph√≤ng T{{ latestPayment.month }}/{{ latestPayment.year }}
            </p>
            <p class="text-gray-600 text-sm">
              S·ªë ti·ªÅn:
              <span class="font-semibold text-red-600">{{
                formatCurrency(latestPayment.total_amount)
              }}</span>
            </p>
            <p class="text-gray-600 text-sm mb-4">
              Tr·∫°ng th√°i:
              <span
                :class="{
                  'text-green-600 font-semibold':
                    latestPayment.payment_status === 'paid',
                  'text-yellow-500 font-semibold':
                    latestPayment.payment_status === 'pending',
                  'text-red-500 font-semibold':
                    latestPayment.payment_status === 'unpaid',
                }"
              >
                {{
                  latestPayment.payment_status === "paid"
                    ? "ƒê√£ thanh to√°n"
                    : latestPayment.payment_status === "pending"
                    ? "ƒêang x·ª≠ l√Ω"
                    : "Ch∆∞a thanh to√°n"
                }}
              </span>
            </p>

            <button
              v-if="latestPayment.payment_status !== 'paid'"
              @click="goToPayments"
              class="mt-auto px-5 py-2 text-sm font-semibold text-white bg-green-500 rounded-full hover:bg-green-600 transition-colors"
            >
              Xem chi ti·∫øt
            </button>
          </template>

          <p v-else class="text-gray-500 text-sm">Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o.</p>
        </div>

        <!-- Th√¥ng khi click v√†o chi ti·∫øt h·ª£p ƒë·ªìng  -->

        <div
          class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-start transition-transform hover:scale-105 hover:shadow-xl duration-300 border-t-4 border-purple-500"
        >
          <div class="flex items-center gap-3 mb-4">
            <svg
              class="w-8 h-8 text-purple-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 20h9M3 20h9M5 8h14M5 12h14M9 16h6"
              />
            </svg>
            <h3 class="text-lg font-bold text-gray-800">Chi ti·∫øt h·ª£p ƒë·ªìng</h3>
          </div>

          <p class="text-gray-600 text-sm mb-4">
            Xem th√¥ng tin chi ti·∫øt h·ª£p ƒë·ªìng l∆∞u tr√∫, th·ªùi h·∫°n v√† ƒëi·ªÅu kho·∫£n c·ªßa
            b·∫°n.
          </p>
          <button
            @click="goToContractDetail"
            class="mt-auto px-5 py-2 text-sm font-semibold text-purple-600 border border-purple-600 rounded-full hover:bg-purple-600 hover:text-white transition-colors"
          >
            Xem h·ª£p ƒë·ªìng
          </button>
        </div>
      </div>

      <section class="mb-12">
        <h3 class="text-2xl font-bold text-gray-800 mb-6">
          Ti·ªán √≠ch K√Ω t√∫c x√°
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6">
          <!-- N√∫t B√°o c√°o thi·∫øt b·ªã -->
          <a
            href="#"
            @click.prevent="openReportFacilities"
            class="flex flex-col items-center p-6 bg-white rounded-xl shadow-lg transition-transform hover:scale-105 hover:shadow-xl duration-300"
          >
            <svg
              class="w-12 h-12 text-primary-blue mb-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              ></path>
            </svg>
            <span class="text-sm font-semibold text-dark-text"
              >B√°o c√°o thi·∫øt b·ªã</span
            >
          </a>

          <!-- Modal danh s√°ch thi·∫øt b·ªã -->
          <transition name="fade">
            <div
              v-if="showFacilitiesModal"
              class="fixed inset-0 bg-black/40 flex items-center justify-center z-50"
            >
              <div
                class="bg-white rounded-xl shadow-xl w-full max-w-3xl p-6 relative animate-fadeIn overflow-y-auto max-h-[80vh]"
              >
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                  Danh s√°ch thi·∫øt b·ªã ph√≤ng
                </h2>
                <button
                  @click="showFacilitiesModal = false"
                  class="absolute top-3 right-3 text-gray-500 hover:text-gray-800"
                >
                  ƒê√≥ng
                </button>

                <div v-if="facilities.length > 0" class="space-y-3">
                  <div
                    v-for="facility in facilities"
                    :key="facility.id"
                    class="flex justify-between items-center p-3 border rounded-lg"
                  >
                    <div>
                      <p class="font-semibold">{{ facility.facility_name }}</p>
                      <p class="text-sm text-gray-500">
                        M√£: {{ facility.facility_code }}
                      </p>
                      <p
                        class="text-sm"
                        :class="
                          facility.status === 'broken'
                            ? 'text-red-500'
                            : 'text-green-600'
                        "
                      >
                        Tr·∫°ng th√°i:
                        {{ facility.status === "broken" ? "H·ªèng" : "T·ªët" }}
                      </p>
                    </div>
                    <button
                      v-if="facility.status !== 'broken'"
                      @click="reportFacility(facility)"
                      class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600"
                    >
                      B√°o c√°o h·ªèng
                    </button>
                  </div>
                </div>

                <p v-else class="text-gray-500 text-sm">
                  Ch∆∞a c√≥ thi·∫øt b·ªã n√†o trong ph√≤ng.
                </p>
              </div>
            </div>
          </transition>

          <transition name="fade">
            <div
              v-if="showDepartureForm"
              class="fixed inset-0 bg-black/40 flex items-center justify-center z-50"
            >
              <div
                class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 relative animate-fadeIn"
              >
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                  Y√™u c·∫ßu r·ªùi KTX
                </h2>

                <form
                  @submit.prevent="submitDepartureRequest"
                  class="space-y-4"
                >
                  <!-- <div>
                    <label
                      class="block text-sm font-semibold text-gray-700 mb-1"
                      >M√£ sinh vi√™n</label
                    >
                    <input
                      type="text"
                      v-model="departureForm.student_code"
                      readonly
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-100 cursor-not-allowed"
                    />
                  </div> -->

                  <div>
                    <label
                      class="block text-sm font-semibold text-gray-700 mb-1"
                      >L√Ω do r·ªùi</label
                    >
                    <textarea
                      v-model="departureForm.reason"
                      rows="3"
                      placeholder="Nh·∫≠p l√Ω do..."
                      required
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring focus:ring-blue-200"
                    ></textarea>
                  </div>

                  <div>
                    <label
                      class="block text-sm font-semibold text-gray-700 mb-1"
                      >Ng√†y r·ªùi d·ª± ki·∫øn</label
                    >
                    <input
                      type="text"
                      v-model="departureForm.request_date"
                      required
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring focus:ring-blue-200"
                    />
                  </div>

                  <div class="flex justify-end space-x-3 mt-6">
                    <button
                      type="button"
                      @click="closeDepartureForm"
                      class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200"
                    >
                      H·ªßy
                    </button>
                    <button @click="submitDepartureRequest">G·ª≠i ƒë∆°n</button>
                  </div>
                </form>
              </div>
            </div>
          </transition>

          <!-- <a
            href="#"
            class="flex flex-col items-center p-6 bg-white rounded-xl shadow-lg transition-transform hover:scale-105 hover:shadow-xl duration-300"
          >
            <svg
              class="w-12 h-12 text-primary-blue mb-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16m-7 6h7"
              ></path>
            </svg>
            <span class="text-sm font-semibold text-dark-text">G√≥p √Ω</span>
          </a> -->
          <a
            href="#"
            v-if="!departureRequested"
            @click.prevent="openDepartureForm"
            class="flex flex-col items-center p-6 bg-white rounded-xl shadow-lg transition-transform hover:scale-105 hover:shadow-xl duration-300"
          >
            <svg
              class="w-12 h-12 text-red-500 mb-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H7a2 2 0 01-2-2V7a2 2 0 012-2h4a2 2 0 012 2v1"
              />
            </svg>
            <span class="text-sm font-semibold text-dark-text"
              >Y√™u c·∫ßu r·ªùi KTX</span
            >
          </a>

          <!-- N√∫t ch·ªù ph√™ duy·ªát -->
          <div
            v-else
            class="flex flex-col items-center p-6 bg-gray-100 rounded-xl shadow-md cursor-not-allowed"
          >
            <svg
              class="w-12 h-12 text-gray-400 mb-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H7a2 2 0 01-2-2V7a2 2 0 012-2h4a2 2 0 012 2v1"
              />
            </svg>
            <span class="text-sm font-semibold text-gray-500"
              >ƒêang ch·ªù ph√™ duy·ªát</span
            >
          </div>

          <!-- C√°c ti·ªán √≠ch kh√°c gi·ªØ nguy√™n -->
        </div>
      </section>

      <!-- Li√™n h·ªá -->
      <section id="contact" class="mt-24">
        <div
          class="rounded-2xl overflow-hidden grid grid-cols-1 lg:grid-cols-2 shadow-lg border-2 border-cyan-200"
        >
          <div class="p-8 md:p-12 bg-gradient-to-br from-cyan-50 to-white">
            <img
              src="/img/logo.png"
              alt="Logo"
              class="h-20 w-20 mb-6 rounded-full shadow-md border-4 border-cyan-200"
            />
            <h2 class="text-2xl font-bold mb-2 text-cyan-700">
              Li√™n h·ªá Ban Qu·∫£n l√Ω K√Ω t√∫c x√°
            </h2>
            <p class="text-slate-600 mb-6">
              Ch√∫ng t√¥i lu√¥n s·∫µn s√†ng h·ªó tr·ª£ b·∫°n. Vui l√≤ng li√™n h·ªá qua c√°c th√¥ng
              tin d∆∞·ªõi ƒë√¢y.
            </p>

            <ul class="space-y-4 text-slate-700">
              <li class="flex items-start gap-3">
                <span class="text-cyan-600">üìç</span>
                <span>[ƒê·ªãa ch·ªâ K√Ω t√∫c x√°], Thanh Oai, H√† N·ªôi</span>
              </li>
              <li class="flex items-center gap-3">
                <span class="text-cyan-600">üìû</span>
                <span>024-XXX-YYYY (VƒÉn ph√≤ng)</span>
              </li>
              <li class="flex items-center gap-3">
                <span class="text-cyan-600">‚úâÔ∏è</span>
                <span>kytucxa@thanhhoaia.edu.vn</span>
              </li>
              <li class="flex items-center gap-3">
                <span class="text-cyan-600">üïì</span>
                <span>Gi·ªù l√†m vi·ªác: 7h30 - 17h00 (Th·ª© 2 - Th·ª© 6)</span>
              </li>
            </ul>
          </div>

          <div
            class="p-8 md:p-12 bg-gradient-to-br from-cyan-600 to-blue-700 text-white"
          >
            <h3 class="text-xl font-bold mb-4 text-cyan-200">
              C·∫©m Nang K√Ω T√∫c X√°
            </h3>
            <ul class="space-y-3">
              <li>
                <a
                  href="#"
                  class="flex items-center gap-3 text-white hover:text-cyan-200 transition-all"
                >
                  üìò <span>N·ªôi quy & Quy ƒë·ªãnh chung KTX</span>
                </a>
              </li>
              <li>
                <a
                  href="#"
                  class="flex items-center gap-3 text-white hover:text-cyan-200 transition-all"
                >
                  üí≥ <span>H∆∞·ªõng d·∫´n thanh to√°n chi ph√≠ n·ªôi tr√∫</span>
                </a>
              </li>
              <li>
                <a
                  href="#"
                  class="flex items-center gap-3 text-white hover:text-cyan-200 transition-all"
                >
                  ‚ùì <span>C√°c c√¢u h·ªèi th∆∞·ªùng g·∫∑p (FAQs)</span>
                </a>
              </li>
              <li>
                <a
                  href="#"
                  class="flex items-center gap-3 text-white hover:text-cyan-200 transition-all"
                >
                  ‚ö†Ô∏è <span>B√°o c√°o s·ª± c·ªë & Y√™u c·∫ßu s·ª≠a ch·ªØa</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </section>
    </div>
  </div>
</template>

<script setup>
definePageMeta({
  layout: "student",
  middleware: "auth",
});

const router = useRouter();

const { user } = useAuth();
import useAxios from "@/composables/useAxios";

const api = useAxios();

const showRoomDetail = ref(false);
const roomDetail = ref([]);
const latestPayment = ref(null);

const goToContractDetail = () => {
  navigateTo("/student/contract"); // chuy·ªÉn sang trang contract.vue
};

onMounted(async () => {
  try {
    // 1Ô∏è‚É£ Ki·ªÉm tra h√≥a ƒë∆°n qu√° h·∫°n
    const { data: paymentData } = await api.get("/student/checkoverduepayments");

    if (paymentData.status && paymentData.overdue_count && paymentData.overdue_count > 0) {
      alert(`B·∫°n c√≥ ${paymentData.overdue_count} h√≥a ƒë∆°n ƒë√£ qu√° h·∫°n thanh to√°n kh√¥ng th√¨ s·∫Ω vi ph·∫°m!`);
    }

    if (paymentData.status && paymentData.locked) {
      alert(paymentData.message);
      router.push('/'); // '/locked' l√† trang ch·ªâ hi·ªÉn th·ªã n√∫t login
      return; // tr√°nh check h·ª£p ƒë·ªìng n·∫øu t√†i kho·∫£n b·ªã kh√≥a do h√≥a ƒë∆°n
    }

    // 2Ô∏è‚É£ Ki·ªÉm tra h·ª£p ƒë·ªìng qu√° h·∫°n
    const { data: contractData } = await api.get("/student/checkcontractstatus");

    if (contractData.status && contractData.alert) {
      alert(contractData.alert);
    }

    if (contractData.status && contractData.locked) {
      alert("T√†i kho·∫£n c·ªßa b·∫°n b·ªã h·∫°n ch·∫ø thao t√°c do h·ª£p ƒë·ªìng qu√° h·∫°n > 45 ng√†y.");
      router.push('/student/contract'); // '/locked' l√† trang ch·ªâ hi·ªÉn th·ªã n√∫t login
      return;
    }
  } catch (error) {
    console.error("L·ªói khi ki·ªÉm tra h√≥a ƒë∆°n ho·∫∑c h·ª£p ƒë·ªìng:", error);
  }
});



// onMounted(async () => {
//   try {
//     const { data } = await api.get("/student/checkoverduepayments");

//     // Th√¥ng b√°o h√≥a ƒë∆°n qu√° h·∫°n
//     if (data.status && data.overdue_count && data.overdue_count > 0) {
//       alert(`B·∫°n c√≥ ${data.overdue_count} h√≥a ƒë∆°n ƒë√£ qu√° h·∫°n thanh to√°n!`);
//     }

//     // N·∫øu b·ªã kh√≥a ‚Üí redirect sang trang ‚Äúch·ªâ c√≥ login‚Äù
//     if (data.status && data.locked) {
//       alert(data.message);
//       router.push('/'); // '/locked' l√† trang hi·ªÉn th·ªã n√∫t login
//     }
//   } catch (error) {
//     console.error("L·ªói khi ki·ªÉm tra h√≥a ƒë∆°n:", error);
//   }
// });

// onMounted(async () => {
//   try {
//     const { data } = await api.get("/student/checkcontractstatus");

//     // Th√¥ng b√°o h·ª£p ƒë·ªìng qu√° h·∫°n
//     if (data.status && data.alert) {
//       alert(data.alert);
//     }

//     // N·∫øu b·ªã kh√≥a ‚Üí redirect sang trang ‚Äúch·ªâ c√≥ login‚Äù
//     if (data.status && data.locked) {
//       alert("T√†i kho·∫£n c·ªßa b·∫°n b·ªã h·∫°n ch·∫ø thao t√°c do h·ª£p ƒë·ªìng qu√° h·∫°n > 2 th√°ng.");
//       router.push('/'); // '/locked' l√† trang hi·ªÉn th·ªã n√∫t login
//     }
//   } catch (error) {
//     console.error("L·ªói khi ki·ªÉm tra h·ª£p ƒë·ªìng:", error);
//   }
// });

// G·ªçi h√†m khi trang load
// onMounted(() => {
//   checkOverduePayments();
// });

onMounted(async () => {
  try {
    const { data } = await api.get("/student/showmypayments"); // g·ªçi route showMyPayments

    if (data.status && data.payments.length > 0) {
      // l·∫•y h√≥a ƒë∆°n m·ªõi nh·∫•t (theo year, month)
      latestPayment.value = data.payments[0];
    }
  } catch (error) {
    console.error("L·ªói khi t·∫£i h√≥a ƒë∆°n:", error);
  }
});

const formatCurrency = (num) => {
  if (!num) return "0 VNƒê";
  return Number(num).toLocaleString("vi-VN") + " VNƒê";
};

const goToPayments = () => {
  // chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang h√≥a ƒë∆°n chi ti·∫øt
  navigateTo("/student/payments");
};

const openRoomDetail = async () => {
  showRoomDetail.value = true;
  try {
    // ‚úÖ G·ªçi ƒë√∫ng API kh√¥ng c√≥ room_id
    const { data } = await api.get(`/student/showroomstudent`);

    if (data.status) {
      roomDetail.value = data.room;
    } else {
      console.warn("Kh√¥ng t√¨m th·∫•y ph√≤ng:", data.message);
      roomDetail.value = null;
    }
  } catch (error) {
    console.error("L·ªói khi t·∫£i chi ti·∫øt ph√≤ng:", error);
    roomDetail.value = null;
  }
};

const closeRoomDetail = () => {
  showRoomDetail.value = false;
};

const showDepartureForm = ref(false);
const departureRequested = ref(false);
const departureForm = reactive({
  student_code: "",
  reason: "",
  request_date: "",
});

const openDepartureForm = () => {
  departureForm.student_code = user.value?.student_code || "";
  showDepartureForm.value = true;
};

const closeDepartureForm = () => {
  showDepartureForm.value = false;
};

// === Thay ƒë·ªïi ch√≠nh: g·ªôp logic g·ª≠i y√™u c·∫ßu r·ªùi KTX + check backend ===
const isSubmitting = ref(false);

const submitDepartureRequest = async () => {
  if (isSubmitting.value) return;
  isSubmitting.value = true;

  try {
    const res = await api.post("/student/postdeparturerequest", departureForm);

    if (res.data.need_confirm) {
      const confirmExit = confirm(res.data.message);
      if (confirmExit) {
        const confirmRes = await api.post("/student/postdeparturerequest", {
          ...departureForm,
          confirm_exit: true,
        });
        alert(confirmRes.data.message);
        departureRequested.value = true;
        showDepartureForm.value = false;
      } else {
        alert("B·∫°n ƒë√£ h·ªßy y√™u c·∫ßu r·ªùi k√Ω t√∫c x√°.");
      }
      return;
    }

    if (res.data.alert) {
      alert(res.data.message);
      return;
    }

    alert(res.data.message);
    departureRequested.value = true;
    showDepartureForm.value = false;
  } catch (err) {
    console.error(err);
    alert(err.response?.data?.message || "C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.");
  } finally {
    isSubmitting.value = false;
  }
};

// === Ti·ªán √≠ch ph√≤ng ===
const showFacilitiesModal = ref(false);
const facilities = ref([]);

const openReportFacilities = async () => {
  showFacilitiesModal.value = true;
  try {
    const { data } = await api.get("/student/showroomfacilities");
    if (data.status) {
      facilities.value = data.facilities;
    } else {
      alert(data.message || "Kh√¥ng th·ªÉ t·∫£i danh s√°ch thi·∫øt b·ªã");
      facilities.value = [];
    }
  } catch (err) {
    console.error(err);
    alert("L·ªói khi t·∫£i danh s√°ch thi·∫øt b·ªã!");
  }
};

const reportFacility = async (facility) => {
  const confirmed = confirm(
    `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën b√°o c√°o thi·∫øt b·ªã "${facility.facility_name}" h·ªèng?`
  );
  if (!confirmed) return;

  try {
    const { data } = await api.post("/student/reportfacility", {
      facility_id: facility.id,
    });
    if (data.status) {
      alert(data.message);
      // C·∫≠p nh·∫≠t tr·∫°ng th√°i thi·∫øt b·ªã tr√™n frontend
      facility.status = "broken";
    } else {
      alert(data.message || "B√°o c√°o th·∫•t b·∫°i");
    }
  } catch (err) {
    console.error(err);
    alert("L·ªói khi g·ª≠i b√°o c√°o!");
  }
};
</script>
